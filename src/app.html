<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker with Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>


    <style>
        body { font-family: Arial, sans-serif; padding: 10px; }
        #status { margin-bottom: 10px; }
        #map {
            width: 800px;
            height: 500px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<h2>User Location Tracker with Map</h2>
<div id="status">Waiting for permission...</div>
<div id="map"></div>
<button onclick="goToMe()" 
        style="position:absolute; top:20px; right:20px; z-index:999; padding:8px 12px;">
    üìç My Location
</button>
<div style="position:absolute; top:70px; right:20px; z-index:999;">
    <input id="usernameInput" 
           type="text" 
           placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."
           style="padding:6px; width:160px;">
</div>



<script>
    const apiURL = "https://live-location-z40f.onrender.com/location";
    let userLocation = null;
    const markers = []; // M·∫£ng ch·ª©a t·∫•t c·∫£ c√°c marker


    // Kh·ªüi t·∫°o map
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let userMarker = null;
    let firstFit = true;
    let username = "private user";

    document.getElementById("usernameInput").addEventListener("input", (e) => {
        username = e.target.value.trim() === "" ? "private user" : e.target.value.trim();

        // N·∫øu ƒë√£ c√≥ marker th√¨ c·∫≠p nh·∫≠t lu√¥n popup
        if (userMarker) {
            userMarker.setPopupContent(username);
        }
    });

    function goToMe() {
        if (userLocation) {
            map.setView(userLocation, 16);
        } else {
            alert("Ch∆∞a c√≥ v·ªã tr√≠ ng∆∞·ªùi d√πng!");
        }
    }

    async function fetchAndUpdateMap() {
        try {
            const res = await fetch(apiURL);
            if (!res.ok) throw new Error("Server returned error");

            const data = await res.json();

            // X√≥a t·∫•t c·∫£ c√°c marker c≈©
            markers.forEach(marker => map.removeLayer(marker));
            markers.length = 0; // X√≥a t·∫•t c·∫£ c√°c marker trong m·∫£ng

            // Hi·ªÉn th·ªã l·∫°i marker c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng
            data.forEach((user, i) => {
                const mk = L.marker([user.lat, user.lon]).addTo(map)
                    .bindPopup(`User #${i + 1}<br>Username: ${user.username}<br>Lat: ${user.lat}<br>Lon: ${user.lon}`);
                markers.push(mk);
            });

            // Fit bounds l·∫ßn ƒë·∫ßu ti√™n khi ƒë√£ c√≥ marker
            if (firstFit && markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2)); // ƒêi·ªÅu ch·ªânh b·∫£n ƒë·ªì ƒë·ªÉ v·ª´a v·ªõi t·∫•t c·∫£ markers
                firstFit = false;
            }

        } catch (err) {
            console.warn("Cannot connect to server:", err);
            document.getElementById("status").innerText = "Server offline ‚Äî only your position is shown.";
        }
    }

    async function updateLocation() {
        const username = document.getElementById("usernameInput").value || "private user";
        const lat = 10.8231;  // S·ª≠ d·ª•ng vƒ© ƒë·ªô ng∆∞·ªùi d√πng th·∫≠t (c√≥ th·ªÉ l·∫•y t·ª´ GPS)
        const lon = 106.6297; // S·ª≠ d·ª•ng kinh ƒë·ªô ng∆∞·ªùi d√πng th·∫≠t (c√≥ th·ªÉ l·∫•y t·ª´ GPS)

        const response = await fetch(apiURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat, lon, username })
        });

        const data = await response.json();
        console.log("Position sent successfully:", data);

        // Sau khi g·ª≠i v·ªã tr√≠, g·ªçi l·∫°i h√†m ƒë·ªÉ c·∫≠p nh·∫≠t t·∫•t c·∫£ v·ªã tr√≠ ng∆∞·ªùi d√πng
        fetchAndUpdateMap();
    }

    // L·∫•y danh s√°ch ng∆∞·ªùi d√πng khi trang ƒë∆∞·ª£c t·∫£i
    fetchAndUpdateMap();

    // C·∫≠p nh·∫≠t l·∫°i danh s√°ch v·ªã tr√≠ ng∆∞·ªùi d√πng m·ªói 5 gi√¢y
    setInterval(fetchAndUpdateMap, 5000); // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
    function denied() {
        document.getElementById("status").innerText = "Permission denied.";
    }

    let lastSent = 0;

    function success(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        userLocation = [lat, lon];

        if (!userMarker) {
            // T·∫°o marker l·∫ßn ƒë·∫ßu
            userMarker = L.marker(userLocation).addTo(map);
            userMarker.bindPopup(username);
            map.setView(userLocation, 16);
        } else {
            // C·∫≠p nh·∫≠t v·ªã tr√≠ marker
            userMarker.setLatLng(userLocation);
            // C·∫≠p nh·∫≠t n·ªôi dung popup theo t√™n m·ªõi
            userMarker.setPopupContent(username);
        }

        document.getElementById("status").innerText = "Location updating...";
    }




    navigator.geolocation.watchPosition(success, denied, { enableHighAccuracy: true });
</script>

</body>
</html>
